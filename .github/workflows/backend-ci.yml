name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f "steward_ai_zorba_bot/requirements.txt" ]; then
            pip install -r steward_ai_zorba_bot/requirements.txt
          fi
          pip install black ruff mypy bandit pytest

      - name: Lint
        run: ruff check .

      - name: Format check
        run: black --check --diff .

      - name: Type check
        run: mypy steward_ai_zorba_bot/ || true  # Allow typecheck to fail for now

      - name: Security check
        run: bandit -r steward_ai_zorba_bot/ -x "*/tests/*" || true

      - name: Run tests
        run: |
          if [ -d "steward_ai_zorba_bot/tests" ]; then
            pytest steward_ai_zorba_bot/tests/ -v
          else
            echo "No tests found, skipping"
          fi

      - name: Validate JSON
        run: |
          python -m json.tool status.json > /dev/null
          python orchestrator.py validate
          echo "status.json is valid"

      - name: Check required files
        run: |
          required_files=("status.json" "README.md" "docs/acceptance_contract.md" "docs/runbook.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Required file $file is missing"
              exit 1
            fi
          done
          echo "All required files present"
